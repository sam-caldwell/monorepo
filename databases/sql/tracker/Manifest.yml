---
header:
  author: Sam Caldwell
  email: mail@samcaldwell.net
  description: |
    This project creates the postgresql tracker database
  opsys:
    - darwin

  arch:
    - amd64
clean:
  enabled: false
  steps:
    - continueOnError: true
      command: "docker exec -it postgresql /bin/bash -c \"echo 'drop database tracker;' | /usr/bin/psql\" &>/dev/null"
build:
  enabled: false
  steps:
    - continueOnError: true
      command: "docker kill postgresql &>/dev/null"
    - continueOnError: true
      command: "docker rm postgresql &>/dev/null"
    - continueOnError: true
      environment:
        - key: listen
          value: 0.0.0.0
        - key: port
          value: 5432
        - key: volume
          value: ./databases/sql
      command: |
        docker run -d --rm --name postgresql -p ${listen}:${port}:${port} -v ${volume}:/opt/ services/postgresql
    - continueOnError: true
      environment:
        - key: db_host
          value: 192.168.3.190
        - key: db_port
          value: 5432
        - key: db_name
          value: postgres
        - key: db_user
          value: admin
        - key: db_pass
          value: admin
        - key: use_tls
          value: false
      command: |
        go run go/db/dbMigrations/main.go
test:
  enabled: true
  steps:
    - continueOnError: true
      environment:
        - key: db_host
          value: 192.168.3.190
        - key: db_port
          value: 5432
        - key: db_name
          value: tracker
        - key: db_user
          value: admin
        - key: db_pass
          value: admin
        - key: use_tls
          value: false
      command: |
        go test -v -failfast ./databases/sql/...
